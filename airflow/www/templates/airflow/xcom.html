{#
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
#}
{% extends "airflow/task_instance.html" %}
{% block title %}Airflow - DAGs{% endblock %}

{% block body %}
    {{ super() }}
    <h4>{{ title }}</h4>
    <div>
        <table class="table table-striped table-bordered model-list">
            <tr>
                {% if edit_mode %}
                <th>&nbsp;</th>
                {% endif %}
                <th>Key</th>
                <th>Value</th>
            </tr>
            {% if edit_mode %}
            {% for attr, value in effective_xcoms.items() %}
                <tr>
                    <td class="list-buttons-column">
                        <a class="icon" id="{{ attr }}" href="#" onclick="edit_value(this.id);" title="Edit Record">
                            <span class="fa fa-pencil glyphicon glyphicon-pencil" >
                            </span>
                        </a>
                        <form class="icon" method="POST" action="/admin/xcom/delete/">
                            <input id="id" name="id" required type="hidden" value="{{ value.id }}" />
                            <input id="url" name="url" type="hidden" value="/admin/xcom/" />
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button onclick="return confirm('Are you sure you want to delete this record?');" title="Delete Record">
                                <span class="fa fa-trash glyphicon glyphicon-trash" data-original-title title >
                                </span>
                            </button>
                        </form>
                    </td>
                    <td>{{ attr }}</td>
                    <td>
                        <div id="value-{{ attr }}" class='code' contenteditable="false">
                            {{ value.value }}
                        </div>
                        <a class="icon" id="save-{{ attr }}" href="#" title="Save" onclick="save_value('{{ attr }}', '{{ value.id }}');" style="display: none;">
                            <span class="glyphicon glyphicon-floppy-disk" >
                            </span>
                        </a>
                        <a class="icon" id="reset-{{ attr }}" href="#" title="Cancel" onclick="reset_value('{{ attr }}');" style="display: none;">
                            <span class="glyphicon glyphicon-remove-sign" >
                            </span>
                        </a>
                    </td>
                </tr>
            {% endfor %}
            {% else %}
            {% for attr, value in attributes %}
                <tr>
                    <td>{{ attr }}</td>
                    <td class='code'>{{ value }}</td>
                </tr>
            {% endfor %}
            {% endif %}
        </table>
        {{ html_code|safe }}
    </div>
{% endblock %}
{% block tail %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            $('input#url').each(function () {
                this.value = window.location.href;
            });
        });

        function edit_value(attr) {
            $('#value-' + attr).each(function () {
                this.contentEditable = true;
                this.focus();
            });
            $('#save-' + attr).show();
            $('#reset-' + attr).show();
        }

        function save_value(attr, id) {
            $.post(
                "{{ url_for('airflow.xcom_edit') }}",
                { 'csrf_token': "{{ csrf_token() }}", 'xcom_id': id, 'value': $("#value-" + attr).text().trim() }
            ).done(
                function(resp) {
                    $('#value-' + attr).css("color", "green");
                }
            ).fail(
                function(jqxhr, textStatus, err) {
                    alert(err);
                    $('#value-' + attr).css("color", "red");
                }
            ).always(
                function () {
                    $('#value-' + attr).each(function () {
                        this.contentEditable = false;
                    });
                    $('#save-' + attr).hide();
                    $('#reset-' + attr).hide();
                }
            );
        }

        function reset_value(attr) {
            $('#value-' + attr).each(function () {
                this.contentEditable = false;
            });
            $('#save-' + attr).hide();
            $('#reset-' + attr).hide();
        }
    </script>
{% endblock %}
